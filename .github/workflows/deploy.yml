name: Build & Deploy Github Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    name: Build & Deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: "24.x"

      - name: Install sitemap generator
        run: npm install -g sitemap-generator-cli

      - name: Generate sitemap from repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_OWNER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          SITEMAP_FILE=./sitemap.xml

          echo '<?xml version="1.0" encoding="UTF-8"?>' > $SITEMAP_FILE
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> $SITEMAP_FILE

          # Get all repos with Github Pages
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               "https://api.github.com/users/$REPO_OWNER/repos?per_page=100" \
               | jq -r '.[] | select(.has_pages==true) | .name' \
               | while read REPO; do
                   URL="https://${REPO_OWNER}.github.io/${REPO}/"
                   echo "Crawling $URL"
                   # Generate temporary sitemap for this repo
                   TEMP_SITEMAP="./temp_sitemap.xml"
                   sitemap-generator "$URL" --output "$TEMP_SITEMAP" --maxDepth 0 --ignore querystring
                   # Merge the URLs into main sitemap (strip XML headers)
                   sed '1d;$d' "$TEMP_SITEMAP" >> $SITEMAP_FILE
                 done

          echo '</urlset>' >> $SITEMAP_FILE

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
