name: Build & Deploy Github Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    name: Build & Deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: "24.x"

      - name: Install sitemap generator
        run: npm install -g sitemap-generator-cli

      - name: Crawl GH Pages and Generate Combined Sitemap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          SITEMAP_PATH: sitemap.xml
        run: |
          mkdir -p sitemaps

          repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                       "https://api.github.com/users/$OWNER/repos?per_page=100" \
                  | jq -r '.[].name')

          for repo in $repos; do
            echo "Processing $repo..."

            # Check if GH Pages is enabled
            pages_url=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                             "https://api.github.com/repos/$OWNER/$repo/pages" \
                          | jq -r '.html_url // empty')

            if [ -z "$pages_url" ]; then
              echo "No GH Pages for $repo, skipping."
              continue
            fi

            # Crawl site and generate sitemap (skip on failure)
            sitemap_file="sitemaps/${repo}_sitemap.xml"
            if sitemap-generator "$pages_url" -f "$sitemap_file"; then
              echo "Sitemap generated for $repo"
            else
              echo "Failed to crawl $repo, skipping."
            fi
          done

          # Combine all sitemaps
          echo '<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' > $SITEMAP_PATH
          for f in sitemaps/*.xml; do
            [ ! -s "$f" ] && continue
            grep -oP '(?<=<url>).*?(?=</url>)' "$f" | while read -r url_content; do
              echo "<url>$url_content</url>" >> $SITEMAP_PATH
            done
          done
          echo '</urlset>' >> $SITEMAP_PATH

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
