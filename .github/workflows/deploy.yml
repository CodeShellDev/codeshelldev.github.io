name: Build & Deploy Github Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    name: Build & Deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: "24.x"

      - name: Install sitemap generator
        run: npm install -g sitemap-generator-cli

      - name: Generate sitemap from repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_OWNER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          SITEMAP_FILE=./sitemap.xml

          echo '<?xml version="1.0" encoding="UTF-8"?>' > $SITEMAP_FILE
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> $SITEMAP_FILE

          # Get all repos with Github Pages
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/users/$REPO_OWNER/repos?per_page=100" \
                  | jq -r '.[] | select(.has_pages==true) | .name' \
                  | while read REPO; do
                      URL="https://${REPO_OWNER}.github.io/${REPO}/"
                      echo "Crawling $URL"

                      TEMP_SITEMAP="./temp/${REPO}_sitemap.xml"

                      # Generate sitemap, continue if it fails
                      sitemap-generator "$URL" --output "$TEMP_SITEMAP" --maxDepth 0 --ignore querystring || echo "Crawl failed for $URL, skipping"

                      # Merge if file exists
                      if [ -f "$TEMP_SITEMAP" ]; then
                          # Extract <url> entries without XML header and urlset tags
                          sed '1d;$d' "$TEMP_SITEMAP" \
                          | while read line; do
                              # Extract the URL inside <loc>...</loc>
                              LOC=$(echo "$line" | sed -n 's|.*<loc>\(.*\)</loc>.*|\1|p')
                              # Ignore URLs where path equals the domain (e.g., user.github.io/user.github.io)
                              DOMAIN="https://${REPO_OWNER}.github.io"
                              if [[ "$LOC" != "$DOMAIN/$DOMAIN"* ]]; then
                                  echo "$line" >> $SITEMAP_FILE
                              fi
                          done
                      fi
                  done

          echo '</urlset>' >> $SITEMAP_FILE

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
